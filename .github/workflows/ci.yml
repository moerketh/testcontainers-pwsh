name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

env:
  DOTNET_VERSION: '8.0.x'
  POWERSHELL_VERSION: '7.4.x'

jobs:
  build:
    name: Build
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}
        
    - name: Restore dependencies
      run: dotnet restore
      
    - name: Build solution
      run: dotnet build --configuration Debug --no-restore
      
    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: build-artifacts
        path: |
          src/*/bin/Debug/net8.0/
        retention-days: 1

  test:
    name: Test
    runs-on: ubuntu-latest
    needs: build
    
    strategy:
      fail-fast: false
      matrix:
        test-module:
          - Azurite
          - CosmosDb
          - Elasticsearch
          - Kafka
          - Keycloak
          - Kusto
          - Minio
          - MongoDb
          - MsSql
          - MySql
          - PostgreSql
          - RabbitMq
          - Redis
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}
        
    - name: Download build artifacts
      uses: actions/download-artifact@v4
      with:
        name: build-artifacts
        path: src/
        
    - name: Install Pester
      shell: pwsh
      run: |
        Install-Module -Name Pester -Force -SkipPublisherCheck -MinimumVersion 5.0.0
        
    - name: Run tests for ${{ matrix.test-module }}
      shell: pwsh
      run: |
        $testFile = "tests/TestcontainersPwsh.${{ matrix.test-module }}.Tests.ps1"
        if (Test-Path $testFile) {
          Write-Host "Running tests for ${{ matrix.test-module }}..."
          Invoke-Pester -Path $testFile -Output Detailed -CI
        } else {
          Write-Warning "Test file not found: $testFile"
          exit 0
        }
      env:
        # Ensure containers can be created
        DOCKER_HOST: unix:///var/run/docker.sock
        
    - name: Upload test results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: test-results-${{ matrix.test-module }}
        path: testResults*.xml
        retention-days: 7

  test-summary:
    name: Test Summary
    runs-on: ubuntu-latest
    needs: test
    if: always()
    
    steps:
    - name: Download all test results
      uses: actions/download-artifact@v4
      with:
        pattern: test-results-*
        path: test-results/
        
    - name: Display test summary
      shell: pwsh
      run: |
        Write-Host "Test Execution Complete" -ForegroundColor Green
        Write-Host "=========================" -ForegroundColor Green
        
        $testResultFiles = Get-ChildItem -Path test-results -Filter "testResults*.xml" -Recurse
        
        if ($testResultFiles.Count -gt 0) {
          Write-Host "Found $($testResultFiles.Count) test result file(s)"
          foreach ($file in $testResultFiles) {
            Write-Host "  - $($file.FullName)"
          }
        } else {
          Write-Host "No test result files found"
        }

  lint:
    name: Lint PowerShell
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Install PSScriptAnalyzer
      shell: pwsh
      run: |
        Install-Module -Name PSScriptAnalyzer -Force -SkipPublisherCheck
        
    - name: Run PSScriptAnalyzer
      shell: pwsh
      run: |
        $results = Invoke-ScriptAnalyzer -Path . -Recurse -Settings PSGallery -Severity Warning,Error
        
        if ($results) {
          Write-Host "PSScriptAnalyzer found $($results.Count) issue(s):" -ForegroundColor Yellow
          $results | Format-Table -AutoSize
          
          # Fail if there are errors
          $errors = $results | Where-Object { $_.Severity -eq 'Error' }
          if ($errors) {
            Write-Host "Found $($errors.Count) error(s)" -ForegroundColor Red
            exit 1
          }
        } else {
          Write-Host "✓ No issues found!" -ForegroundColor Green
        }

  status-check:
    name: Status Check
    runs-on: ubuntu-latest
    needs: [build, test, lint]
    if: always()
    
    steps:
    - name: Check workflow status
      shell: pwsh
      run: |
        $buildStatus = "${{ needs.build.result }}"
        $testStatus = "${{ needs.test.result }}"
        $lintStatus = "${{ needs.lint.result }}"
        
        Write-Host "Build Status: $buildStatus"
        Write-Host "Test Status: $testStatus"
        Write-Host "Lint Status: $lintStatus"
        
        if ($buildStatus -ne "success" -or $testStatus -ne "success" -or $lintStatus -ne "success") {
          Write-Host "❌ Workflow failed!" -ForegroundColor Red
          exit 1
        } else {
          Write-Host "✓ All checks passed!" -ForegroundColor Green
        }
